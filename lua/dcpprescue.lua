-- DC++ Rescue 0.0.2.3
-- © 2022 RoLex & DC++ Team

conf = {
	info = {
		[":RU:UA:BY:"] = -- russian translation
[[
Âàæíîå ñîîáùåíèå äëÿ ïîëüçîâàòåëåé ñ êëèåíòîì DC++:

 Èç-çà ïðîáëåìû ñ õîñòèíãîì ïðîåêòà DC++, ïðîâåðêà îáíîâëåíèé áîëüøå íå ðàáîòàåò
 îò âåðñèè DC++ 0.870 è íèæå. Ïîòîìó â ýòîò ðàç âàì íåîáõîäèìî ïðîâåñòè ðó÷íîå
 îáíîâëåíèå, ñêà÷àâ ñàìóþ ïîñëåäíþþ âåðñèþ 0.871 èëè âûøå, ñ îôèöèàëüíîãî ñàéòà
 ïðîåêòà ïî ññûëêå <https://dcplusplus.sourceforge.io/download.html>. Ïîæàëóéñòà
 óáåäèòåñü, äëÿ âàøåé æå áåçîïàñíîñòè, ÷òî âû ñêà÷èâàåòå DC++ èìåííî ñ óêàçàííîãî
 îôèöèàëüíîãî ñàéòà, à íå ñ ñàéòîâ òðåòèõ ñòîðîí, ññûëêè íà êîòîðûå ìîæíî íàéòè
 â èíòåðíåòå. Êàê òîëüêî âû îáíîâèòå êëèåíò, ýòî ñîîáùåíèå àâòîìàòè÷åñêè ïðåêðàòèò
 ñâî¸ äåéñòâèå. Ïðèíîñèì ñâîè èçâèíåíèÿ çà íåóäîáñòâà.
]],
		[":PL:"] = -- polish translation
[[
Wazna uwaga dla uzytkownikow klienta DC++:

 Z powodu problemu z hostingiem projektu DC++, sprawdzanie aktualizacji
 jest niedostepne w wersji DC++ 0.870 oraz starszych. Z tego powodu uzytkownicy
 powinni pobrac wersje DC++ 0.871 lub nowsza i wykonac manualna aktualizacje
 programu. Najnowsza wersje klienta mozesz pobrac na stronie projektu DC++ pod
 adresem <https://dcplusplus.sourceforge.io/download.html>. Dla wlasnego
 bezpieczenstwa prosze pobrac najnowsza wersje klienta tylko z oficjalnej
 strony projektu DC++. Po aktualizacji klienta przestaniesz dostawac ta wiadomosc.
]],
		[":RO:MD:"] = -- romanian translation
[[
Nota importanta pentru utilizatorii clientului DC++:

 Din cauza unei probleme cu gazduirea proiectului DC++, verificarea actualizari
 este întrerupta in DC++ pentru versiunea 0.870 si in orice versiune mai veche.
 Prin urmare, utilizatorii ar trebui sa faca actualizarea manuala de data aceasta
 si sa descarce cea mai noua versiune 0.871 sau vizitand site-ul de descarcare
 al proiectului la <https://dcplusplus.sourceforge.io/download.html>. Va rugam
 pentru propria siguranta dvs, sa descarcati DC++ de pe aceasta pagina a site
 oficial si nu de pe alte site-uri web sau de pe alte motoare de cautare ce va
 pot sugera. Dupa ce ati actualizat clientul, acest mesaj se va intrerupe automat.
 Ne cerem scuze pentru neplacerile create.
]],
		[":HU:"] = -- hungarian translation
[[
Fontos uzenet DC++ felhasznaloknak:

 A projekt altal hasznalt web kiszolgalo hibaja miatt a frissitesek keresese
 nem mukodik a DC++ 0.870 es korabbi verzioiban ezert most kivetelesen a
 frissitest kezzel kell elvegezni. A legujabb 0.871-es verzio letoltheto a
 hivatalos honlaprol <https://dcplusplus.sourceforge.io/download.html>.
 Sajat erdekedben mindig innen toltsd le a DC++-t es ne a keresok altal
 feldobott mas egyeb weboldalakrol. A frissites utan ez az uzenet el fog
 tunni. Bocs a kellemetlensegert.
]],
		[":ES:"] = -- spanish translation
[[
Nota importante para los usuarios del cliente DC++:

 Debido a un problema con el alojamiento del proyecto DC++, ahora la comprobacion
 de actualizaciones esta rota en la version 0.870 de DC++ y en las anteriores.
 Por lo tanto, los usuarios deben hacer la actualizacion manualmente esta vez
 y descargar la mas nueva version 0.871 o posterior visitando la pagina de
 descargas del proyecto en <https://dcplusplus.sourceforge.io/download.html>.
 Por favor, asegurese, por su propia seguridad, de que descarga DC++ desde este
 sitio oficial y no de otros sitios web de terceros que los motores de busqueda
 pueden sugerir. Una vez que haya actualizado su cliente, este mensaje se
 interrumpira automaticamente. Disculpa las molestias.
]],
		[":PT:"] = -- portuguese translation
[[
Notificacao importante para usuarios DC++ usuarios de cliente:

 Devido a um problema com o hosting do projeto do DC++, a verificacao de update
 deixou de funcionar na versao 0.870 e acima do DC++. Ou seja usuarios devem
 fazer o upgrade manualmente desta vez e descarregar a mais recente versao 0.871
 e acima, esta encontra se acessivel ao visitar a pagina de download do website
 do projeto em <https://dcplusplus.sourceforge.io/download.html>. Por favor
 certifiquem se, para a vossa propria seguranca, que descarregam o DC++ deste
 site oficial e nao de outros websites que os vossos motores de pesquisa possam
 sugerir. Depois de dar upgrade ao seu client, esta mensagem ira automaticamente
 desaparecer. Pedimos desculpa pelo incoviniente.
]],
		[""] = -- english and missing translation
[[
Important note to DC++ client users:

 Due to an issue with the DC++ project's hosting, now update check
 is broken in DC++ version 0.870 and any older. Therefore users
 should do the upgrade manually this time and download the newest
 version 0.871 or later by visiting the project website's download
 page at <https://dcplusplus.sourceforge.io/download.html>. Please
 make sure, for your own safety, that you download DC++ from this
 official site and not from other 3'rd party websites search engines
 may suggest. Once you have upgraded your client, this message
 will automatically discontinue. We are sorry for the inconvenience.
]]
	},
	comm = "dcpprescue", -- information command name
	wait = 30, -- delay in secs before message
	priv = false, -- also send message in pm
	stat = true, -- write rescue statistics
	done = {
		vips = true, -- give vip on rescue complete
		text = "Thank you <nick> for rescuing DC++, you are now awarded with VIP status on this hub. More about this campaign: <command>" -- message to send to all
	}
}

cach = { -- for internal use only
	info = {},
	done = {},
	keep = {}
}

function Main (name)
	if not conf.stat then
		return 1
	end

	VH:SQLQuery ([[
		create table if not exists `lua_dcpp_rescue` (
			`nick` varchar(128) not null primary key, 
			`seen` bigint(20) unsigned not null default 0, 
			`over` varchar(10) null, 
			`otime` bigint(20) unsigned not null default 0, 
			`nver` varchar(10) null, 
			`ntime` bigint(20) unsigned not null default 0
		)
	]])

	local _, rows = VH:SQLQuery ("select `nick`, `nver` from `lua_dcpp_rescue`")

	for pos = 0, rows - 1 do
		local _, nick, ver = VH:SQLFetch (pos)
		cach.keep [nick] = (ver and # ver > 0) or false
	end

	return 1
end

function VH_OnUserLogin (nick, addr)
	local _, clas = VH:GetUserClass (nick)

	if clas < 0 then
		return 1
	end

	local _, info = VH:GetMyINFO (nick)
	local ver = info:match ("^%$MyINFO %$ALL [^ ]+ [^%$]*<%+%+ V:(0%.[0-9]+),M:[^>%$]+>%$")
	ver = tonumber (ver or 0.0) or 0.0

	if ver < 0.674 then
		return 1
	end

	local sql, now = "", os.time ()

	if ver >= 0.871 then
		if not conf.stat then
			return 1
		end

		if cach.keep [nick] == false then
			if conf.done.vips then
				local ok, _ = false, 0

				if clas == 0 then
					ok, _ = VH:AddRegUser (nick, "", 2)
				elseif clas == 1 and VH.SetRegClass then
					ok, _ = VH:SetRegClass (nick, 2)
				end

				if ok and not cach.done [nick] then
					cach.done [nick] = now
				end
			end

			cach.keep [nick] = true
			sql = "update `lua_dcpp_rescue` set `seen` = " .. tostring (now) .. ", `nver` = '" .. tostring (ver) .. "', `ntime` = " .. tostring (now) .. " where `nick` = '" .. safe (nick) .. "'"
		end

	else
		if conf.stat and cach.keep [nick] == nil then
			cach.keep [nick] = false
			sql = "insert ignore into `lua_dcpp_rescue` (`nick`, `seen`, `over`, `otime`) values ('" .. safe (nick) .. "', " .. tostring (now) .. ", '" .. tostring (ver) .. "', " .. tostring (now) .. ")"
		end

		if not cach.info [nick] then
			cach.info [nick] = now
		end
	end

	if conf.stat and cach.keep [nick] ~= nil then
		if # sql == 0 then
			sql = "update `lua_dcpp_rescue` set `seen` = " .. tostring (now) .. " where `nick` = '" .. safe (nick) .. "'"
		end

		VH:SQLQuery (sql)
	end

	return 1
end

function VH_OnUserLogout (nick, addr)
	if cach.info [nick] then
		cach.info [nick] = nil
	end

	return 1
end

function VH_OnHubCommand (nick, data, op, pm)
	if data:sub (2, # conf.comm + 1) == conf.comm then
		local info = conf.info [""] .. "\r\n"

		if conf.stat then
			local sql = "select * from `lua_dcpp_rescue`"

			if data:sub (# conf.comm + 3) ~= "all" then
				sql = sql .. " where `nver` is not null"
			end

			sql = sql .. " order by `seen` desc"
			local _, rows = VH:SQLQuery (sql)

			if rows > 0 then
				local list = ""

				for pos = 0, rows - 1 do
					local _, user, seen, over, otime, nver, ntime = VH:SQLFetch (pos)
					list = list .. " " .. tostring (pos + 1) .. ". [ U: " .. user .. " @ " .. os.date ("%Y-%m-%d", tonumber (seen)) .. " ] [ O: " .. tostring (over) .. " @ " .. os.date ("%Y-%m-%d", tonumber (otime)) .. " ]"

					if nver and # nver > 0 then
						list = list .. " [ N: " .. tostring (nver) .. " @ " .. os.date ("%Y-%m-%d", tonumber (ntime)) .. " ]"
					end

					list = list .. "\r\n"
				end

				info = info .. " DC++ rescue statistics so far:\r\n\r\n" .. list

			else
				info = info .. " DC++ rescue statistics are not yet available, try this instead: !" .. conf.comm .. " all\r\n"
			end

		else
			info = info .. " DC++ rescue statistics are disabled.\r\n"
		end

		VH:SendToUser ("<" .. VH.HubSec .. "> " .. info .. "|", nick)
		return 0
	end

	return 1
end

function VH_OnTimer (msec)
	local del, now = {}, os.time ()

	for nick, secs in pairs (cach.info) do
		if os.difftime (now, secs) >= conf.wait then
			local _, code = VH:GetUserCC (nick)
			local info = ""

			if code and # code == 2 then
				for list, text in pairs (conf.info) do
					if # list > 0 and # text > 0 and list:find (code, 1, true) then
						info = text
						break
					end
				end
			end

			if # info == 0 then
				info = conf.info [""]
			end

			local prot = "<" .. VH.HubSec .. "> " .. info .. "|"

			if conf.priv then
				prot = prot .. "$To: " .. nick .. " From: " .. VH.HubSec .. " $<" .. VH.HubSec .. "> " .. info .. "|"
			end

			VH:SendToUser (prot, nick)
			del [nick] = true
		end
	end

	for nick, _ in pairs (del) do
		cach.info [nick] = nil
	end

	if conf.done.vips then
		del = {}

		for nick, secs in pairs (cach.done) do
			if os.difftime (now, secs) >= conf.wait then
				local text = conf.done.text
				text = text:gsub ("<nick>", rexp (nick))
				text = text:gsub ("<command>", "!" .. conf.comm)
				VH:SendToChat (VH.HubSec, text, 0, 10)
				VH:ScriptCommand ("chat_to_all", "<" .. VH.HubSec .. "> " .. text) -- to catch in ledokol
				del [nick] = true
			end
		end

		for nick, _ in pairs (del) do
			cach.done [nick] = nil
		end
	end

	return 1
end

function safe (data)
	local out = tostring (data)
	out = out:gsub (string.char (92), string.char (92, 92))
	out = out:gsub (string.char (34), string.char (92, 34))
	out = out:gsub (string.char (39), string.char (92, 39))
	return out
end

function rexp (data)
	local out = tostring (data)
	out = out:gsub ("%%", "%%%%")
	return out
end

-- end of file